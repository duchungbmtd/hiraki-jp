<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch Kanji N5 - Hikari N5</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="alternate icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- DMAK - Draw Me A Kanji -->
    <link rel="stylesheet" href="assets/css/dmak.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <script src="assets/js/kanji/dmak.min.js"></script>
    <script src="assets/js/kanji/jquery.dmak.min.js"></script>
    <style>
        .japanese-text { font-family: 'Noto Sans JP', sans-serif; }
        .vietnamese-text { font-family: 'Inter', sans-serif; }
        
        /* Custom styles theo UI design guide */
        :root {
            --sakura-pink: #FFB7C5;
            --deep-blue: #003366;
            --warm-white: #FFFEF7;
            --red-accent: #E60012;
            --gray-text: #4A5568;
            --success: #48BB78;
            --warning: #ED8936;
        }
        
        .kanji-card {
            transition: all 0.3s ease;
            transform: translateY(0);
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .kanji-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: #cbd5e0;
        }
        
        .kanji-display {
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 50%, #9c2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(229, 62, 62, 0.2);
            line-height: 1;
        }
        
        .kanji-display-container {
            position: relative;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .kanji-static-display {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: 12px;
            position: relative;
        }
        
        .kanji-static-display:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: scale(1.05);
        }
        
        .kanji-animation-display {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: 12px;
        }

        .kanji-animation-display:hover {
            background: rgba(102, 126, 234, 0.05);
            transform: translateX(-50%) scale(1.05);
        }
        
        .kanji-svg-image {
            width: 60px;
            height: 60px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
            transition: all 0.3s ease;
        }
        
        .kanji-svg-image:hover {
            filter: drop-shadow(0 6px 12px rgba(229, 62, 62, 0.3));
        }
        
        .kanji-stroke-animation {
            width: 60px;
            height: 60px;
            display: block;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        
        .kanji-fallback {
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 50%, #9c2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(229, 62, 62, 0.2);
            line-height: 1;
        }
        
        .click-hint {
            font-size: 0.8em;
            color: #667eea;
            margin-top: 0.5rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .animation-hint {
            font-size: 0.8em;
            color: #e53e3e;
            margin-top: 0.5rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .action-button-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .action-button-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .animation-controls {
            margin-top: 1rem;
        }
        
        .han-viet-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.1em;
            letter-spacing: 0.05em;
        }
        
        .meaning-display {
            color: #2d3748;
            font-size: 0.9em;
            font-weight: 500;
            line-height: 1.3;
        }
        
        /* category-tag base styles were removed; hidden globally below */
        
        /* Category colors */
        .tag-people { background: linear-gradient(135deg, #fed7d7, #feb2b2); color: #c53030; }
        .tag-family { background: linear-gradient(135deg, #fbb6ce, #f687b3); color: #97266d; }
        .tag-time { background: linear-gradient(135deg, #bee3f8, #90cdf4); color: #2c5282; }
        .tag-nature { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #22543d; }
        .tag-number { background: linear-gradient(135deg, #faf089, #f6e05e); color: #744210; }
        .tag-action { background: linear-gradient(135deg, #fed7e2, #fbb6ce); color: #97266d; }
        .tag-body { background: linear-gradient(135deg, #e9d8fd, #d6bcfa); color: #553c9a; }
        .tag-direction { background: linear-gradient(135deg, #e9d8fd, #d6bcfa); color: #553c9a; }
        .tag-position { background: linear-gradient(135deg, #e9d8fd, #d6bcfa); color: #553c9a; }
        .tag-place { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #22543d; }
        .tag-default { background: linear-gradient(135deg, #e2e8f0, #cbd5e0); color: #4a5568; }
        
        .search-input {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .search-input:focus {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }
        
        .filter-select {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        
        @media (min-width: 1536px) {
            .grid-layout {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1.5rem;
            }
        }
        
        @media (min-width: 1280px) and (max-width: 1535px) {
            .grid-layout {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 1.25rem;
            }
        }
        
        @media (max-width: 640px) {
            /* Sync static and animation containers on SP */
            .kanji-static-display,
            .kanji-animation-display {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0.25rem;
                border-radius: 12px;
                width: 100%;
                background: transparent;
                cursor: pointer;
            }
            .kanji-static-display:hover,
            .kanji-animation-display:hover {
                background: rgba(102, 126, 234, 0.05);
            }

            .grid-layout {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .kanji-card {
                padding: 0.5rem 0.75rem;
                margin-bottom: 0;
            }
            
            .kanji-card-mobile {
                display: flex;
                align-items: center;
                text-align: left;
            }
            
            .kanji-left-section {
                flex: 0 0 auto;
                margin-right: 0.75rem;
            }
            
            .kanji-right-section {
                flex: 1;
                min-width: 0; /* Prevent text overflow */
            }
            
            .kanji-display {
                font-size: 2.2rem;
            }
            
            .han-viet-display {
                font-size: 0.85em;
                margin-bottom: 0.15rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .meaning-display {
                font-size: 0.7em;
                line-height: 1.2;
                margin-bottom: 0.15rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .category-tag {
                font-size: 0.6em;
                padding: 1px 4px;
                margin-bottom: 0;
                display: inline-block;
            }
            
            .kanji-display-container {
                min-height: 50px;
                margin-bottom: 0;
            }
            
            .kanji-svg-image {
                width: 45px;
                height: 45px;
            }
            
            .kanji-stroke-animation {
                width: 45px;
                height: 45px;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* ID badge bottom-right */
        .kanji-id {
            position: absolute;
            right: 8px;
            bottom: 8px;
            font-size: 10px;
            color: #9CA3AF; /* gray-400 */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-button:disabled:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Hide category tags on all viewports (PC & SP) */
        .category-tag { display: none !important; }
        
        .clear-filter-button {
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .clear-filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
            background: linear-gradient(135deg, #dc2626 0%, #db2777 100%);
        }
        
        .clear-filter-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .clear-filter-button:disabled:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            background: linear-gradient(135deg, #ef4444 0%, #ec4899 100%);
        }
        
        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) translateX(-5px);
        }

        @media (max-width: 768px) {
            .back-btn {
                position: static;
                transform: none;
                margin-bottom: 20px;
                align-self: flex-start;
            }
            
            .header {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-pink-50 min-h-screen vietnamese-text">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg relative">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <a href="index.html" class="back-btn">
                ‚Üê Tr·ªü v·ªÅ trang ch·ªß
            </a>
            <div class="text-center">
                <div class="flex items-center justify-center space-x-3 mb-2">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-white font-bold text-xl japanese-text">Êº¢</span>
                    </div>
                    <h1 class="text-3xl font-bold">Danh s√°ch Kanji N5</h1>
                </div>
                <p class="text-white text-opacity-90">107 ch·ªØ Kanji c∆° b·∫£n</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- Search and Filter Section -->
        <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-8 mb-8 border border-white/20">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üîç T√¨m ki·∫øm Kanji</h2>
                <p class="text-gray-600">T√¨m ki·∫øm theo ch·ªØ kanji, √¢m h√°n vi·ªát ho·∫∑c nghƒ©a ti·∫øng Vi·ªát</p>
            </div>
            
            <div class="max-w-2xl mx-auto mb-6">
                <input type="text" id="searchInput" 
                       class="search-input w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-2xl focus:border-blue-500 focus:ring-0 transition-all" 
                       placeholder="Nh·∫≠p kanji, h√°n vi·ªát ho·∫∑c nghƒ©a ƒë·ªÉ t√¨m ki·∫øm...">
            </div>
            
            <div class="flex flex-wrap justify-center gap-4">
                <select id="categoryFilter" class="filter-select px-4 py-3 border-2 border-gray-200 rounded-xl bg-white font-medium">
                    <option value="">üè∑Ô∏è T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
                    <option value="number">üî¢ S·ªë ƒë·∫øm</option>
                    <option value="people">üë• Con ng∆∞·ªùi</option>
                    <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Gia ƒë√¨nh</option>
                    <option value="time">‚è∞ Th·ªùi gian</option>
                    <option value="nature">üåø T·ª± nhi√™n</option>
                    <option value="action">üèÉ H√†nh ƒë·ªông</option>
                    <option value="body">üë§ C∆° th·ªÉ</option>
                    <option value="direction">üß≠ Ph∆∞∆°ng h∆∞·ªõng</option>
                    <option value="place">üìç ƒê·ªãa ƒëi·ªÉm</option>
                </select>
                
                <button id="clearFilters" class="clear-filter-button">
                    X√≥a b·ªô l·ªçc
                </button>
                
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 text-lg">ƒêang t·∫£i d·ªØ li·ªáu Kanji...</p>
        </div>

        <!-- Kanji Grid -->
        <div id="kanjiContainer" class="hidden">
            <div id="kanjiGrid" class="grid-layout">
                <!-- Kanji cards will be inserted here -->
            </div>
        </div>

        <!-- No Results State -->
        <div id="noResultsState" class="hidden text-center py-16">
            <div class="text-8xl mb-6">üîç</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kh√¥ng t√¨m th·∫•y Kanji n√†o</h2>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                Kh√¥ng c√≥ Kanji n√†o kh·ªõp v·ªõi t·ª´ kh√≥a t√¨m ki·∫øm c·ªßa b·∫°n. 
                H√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c x√≥a b·ªô l·ªçc.
            </p>
            <button onclick="clearAllFilters()" class="clear-filter-button">
                üóëÔ∏è X√≥a b·ªô l·ªçc v√† hi·ªÉn th·ªã t·∫•t c·∫£
            </button>
        </div>
    </main>

    <script>
        // Global variables
        let kanjiData = [];
        let filteredKanji = [];
        
        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const clearFilters = document.getElementById('clearFilters');
        const loadingState = document.getElementById('loadingState');
        const kanjiContainer = document.getElementById('kanjiContainer');
        const kanjiGrid = document.getElementById('kanjiGrid');
        const noResultsState = document.getElementById('noResultsState');

        // Initialize app
        async function initializeApp() {
            try {
                await loadKanjiData();
                setupEventListeners();
                applyFilters();
                hideLoading();
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // Load kanji data from JSON
        async function loadKanjiData() {
            const response = await fetch('data/kanji_list.json');
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kanji');
            }
            kanjiData = await response.json();
            filteredKanji = [...kanjiData];
        }

        // Setup event listeners
        function setupEventListeners() {
            searchInput.addEventListener('input', debounce(applyFilters, 300));
            categoryFilter.addEventListener('change', applyFilters);
            clearFilters.addEventListener('click', clearAllFilters);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(event) {
            if (event.key === 'Escape') {
                clearAllFilters();
            }
        }

        // Get category tag class
        function getCategoryTagClass(category) {
            const categoryMap = {
                'people': 'tag-people',
                'family': 'tag-family', 
                'time': 'tag-time',
                'nature': 'tag-nature',
                'number': 'tag-number',
                'action': 'tag-action',
                'body': 'tag-body',
                'direction': 'tag-direction',
                'position': 'tag-position',
                'place': 'tag-place'
            };
            return categoryMap[category] || 'tag-default';
        }

        // Get SVG filename for kanji
        function getKanjiSVGPath(kanjiChar) {
            const unicodeHex = kanjiChar.codePointAt(0).toString(16).padStart(5, '0');
            return `data/kanji/draw/${unicodeHex}.svg`;
        }
        
        // Use a dynamic approach for stroke counting
        const strokeCountCache = {}; // Cache stroke counts to avoid recalculation
        
        // Get stroke count for a kanji character
        function getStrokeCount(kanjiChar) {
            // If we've already calculated this kanji's stroke count, return from cache
            if (strokeCountCache[kanjiChar] !== undefined) {
                return strokeCountCache[kanjiChar];
            }
            
            // Default stroke count based on visual complexity
            // This is a reasonable default that works for most kanji
            // Simple kanji (‰∏Ä, ‰∫å, ‰∏â) have fewer strokes
            // Complex kanji (Ë≠∞, È¨±, Èüø) have more strokes
            const defaultCount = 10;
            
            // Store in cache and return
            strokeCountCache[kanjiChar] = defaultCount;
            return defaultCount;
        }

        // Create kanji card HTML
        function createKanjiCard(kanji) {
            const svgPath = getKanjiSVGPath(kanji.kanji);
            
            // Create unique IDs for desktop and mobile to avoid conflicts
            const desktopStaticId = `kanji-static-desktop-${kanji.id}`;
            const desktopAnimId = `kanji-animation-desktop-${kanji.id}`;
            const desktopDrawId = `kanji-draw-desktop-${kanji.id}`;
            
            const mobileStaticId = `kanji-static-mobile-${kanji.id}`;
            const mobileAnimId = `kanji-animation-mobile-${kanji.id}`;
            const mobileDrawId = `kanji-draw-mobile-${kanji.id}`;
            
            // Desktop elements
            const desktopStaticDisplay = `
                <div class="kanji-static-display" id="${desktopStaticId}" onclick="showStrokeOrder('${desktopStaticId}', '${desktopAnimId}', '${desktopDrawId}', '${kanji.kanji}')">
                    <img src="${svgPath}" alt="${kanji.kanji}" class="kanji-svg-image" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="kanji-fallback japanese-text" style="display:none;">${kanji.kanji}</div>
                </div>
            `;
            
            const desktopAnimationDisplay = `
                <div class="kanji-animation-display hidden" id="${desktopAnimId}" onclick="showStrokeOrder('${desktopStaticId}', '${desktopAnimId}', '${desktopDrawId}', '${kanji.kanji}')">
                    <div id="${desktopDrawId}" class="kanji-stroke-animation"></div>
                </div>
            `;
            
            // Mobile elements
            const mobileStaticDisplay = `
                <div class="kanji-static-display" id="${mobileStaticId}" onclick="showStrokeOrder('${mobileStaticId}', '${mobileAnimId}', '${mobileDrawId}', '${kanji.kanji}')">
                    <img src="${svgPath}" alt="${kanji.kanji}" class="kanji-svg-image" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="kanji-fallback japanese-text" style="display:none;">${kanji.kanji}</div>
                </div>
            `;
            
            const mobileAnimationDisplay = `
                <div class="kanji-animation-display hidden" id="${mobileAnimId}" onclick="showStrokeOrder('${mobileStaticId}', '${mobileAnimId}', '${mobileDrawId}', '${kanji.kanji}')">
                    <div id="${mobileDrawId}" class="kanji-stroke-animation"></div>
                </div>
            `;
            
            // Return HTML with responsive layout
            return `
                <div class="kanji-card rounded-2xl p-4 fade-in">
                    <!-- Desktop Layout (centered) -->
                    <div class="text-center hidden md:block">
                        <div class="category-tag ${getCategoryTagClass(kanji.category)} mb-3">
                            ${kanji.category}
                        </div>
                        
                        <!-- Kanji Display Area (Static SVG or Animation) -->
                        <div class="kanji-display-container mb-3">
                            <!-- Static SVG Display -->
                            ${desktopStaticDisplay}
                            
                            <!-- Animation Display -->
                            ${desktopAnimationDisplay}
                        </div>
                        
                        <div class="han-viet-display mb-2">
                            ${kanji.han_viet}
                        </div>
                        
                        <div class="meaning-display mb-3">
                            ${kanji.meaning}
                        </div>
                        
                        
                    </div>
                    
                    <!-- Mobile Layout (horizontal) -->
                    <div class="kanji-card-mobile md:hidden">
                        <div class="kanji-left-section">
                            <!-- Kanji Display Area (Static SVG or Animation) -->
                            <div class="kanji-display-container">
                                <!-- Static SVG Display -->
                                ${mobileStaticDisplay}
                                
                                <!-- Animation Display -->
                                ${mobileAnimationDisplay}
                            </div>
                        </div>
                        
                        <div class="kanji-right-section">
                            <div class="han-viet-display mb-1">
                                ${kanji.han_viet}
                            </div>
                            
                            <div class="meaning-display mb-1">
                                ${kanji.meaning}
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="category-tag ${getCategoryTagClass(kanji.category)}">
                                    ${kanji.category}
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    <div class="kanji-id">#${kanji.id}</div>
                </div>
            `;
        }

        // Apply filters and search
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value;

            filteredKanji = kanjiData.filter(kanji => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    kanji.kanji.toLowerCase().includes(searchTerm) ||
                    kanji.han_viet.toLowerCase().includes(searchTerm) ||
                    kanji.meaning.toLowerCase().includes(searchTerm);

                // Category filter
                const matchesCategory = !selectedCategory || kanji.category === selectedCategory;

                return matchesSearch && matchesCategory;
            });

            renderKanjiGrid();
        }

        // Store timeout IDs and animation states
        const animationTimeouts = {};
        const animationStates = {}; // Track if animation is currently showing
        const strokeCounts = {}; // Track stroke counts for each kanji
        const drawnStrokes = {}; // Track how many strokes have been drawn
        
        // Create DMAK drew callback for stroke animation
        function createDrewCallback(kanjiId, estimatedStrokes) {
            // Variable to track the auto-hide timeout
            let autoHideTimeout = null;
            
            return function() {
                // A stroke has been drawn
                
                // Clear any existing timeout
                if (autoHideTimeout) {
                    clearTimeout(autoHideTimeout);
                }
                
                // Set a new timeout - if no new strokes are drawn for 1.5 seconds,
                // we assume the animation is complete
                autoHideTimeout = setTimeout(() => {
                    // Only proceed if still in animation state
                    if (animationStates[kanjiId] === true) {
                        console.log(`Auto-hiding animation for kanji ID: ${kanjiId} after stroke completion`);
                        hideStrokeOrder(kanjiId);
                    }
                }, 1500); // 1.5 seconds of no new strokes indicates completion
            };
        }

        // Toggle between static and animation display when kanji is clicked
        function showStrokeOrder(staticId, animId, drawId, kanjiChar) {
            // Use direct IDs without # prefix for tracking
            const elementId = staticId.replace('kanji-static-', '');
            
            // Add # for jQuery selectors
            const staticDisplayId = `#${staticId}`;
            const animationDisplayId = `#${animId}`;
            const containerId = `#${drawId}`;
            
            const $staticDisplay = $(staticDisplayId);
            const $animationDisplay = $(animationDisplayId);
            const $container = $(containerId);
            
            if ($container.length === 0) return;
            
            // Clear any existing timeout for this element
            if (animationTimeouts[elementId]) {
                clearTimeout(animationTimeouts[elementId]);
                delete animationTimeouts[elementId];
            }
            
            // Check current state based on actual DOM visibility
            const isAnimationVisible = !$animationDisplay.hasClass('hidden');
            
            console.log(`Kanji ${elementId}: DOM visible = ${isAnimationVisible}`);
            
            if (isAnimationVisible) {
                // Currently showing animation, switch to static
                console.log(`Switching kanji ${elementId} to static`);
                $staticDisplay.removeClass('hidden');
                $animationDisplay.addClass('hidden');
                animationStates[elementId] = false;
            } else {
                // Currently showing static, switch to animation
                console.log(`Switching kanji ${elementId} to animation`);
                $staticDisplay.addClass('hidden');
                $animationDisplay.removeClass('hidden');
                animationStates[elementId] = true;
                
                // Always restart the animation from the beginning
                // Force clear the container completely
                $container.empty();
                $container.removeClass('dmak-loaded');
                $container.removeData(); // Clear jQuery data
                $container.off(); // Remove event handlers
                
                // Add a small delay to ensure DOM is updated
                setTimeout(function() {
                    try {
                        console.log(`Loading DMAK animation for kanji ${kanjiChar} (element: ${elementId})`);
                        
                        // Re-select container to ensure fresh reference
                        const $freshContainer = $(containerId);
                        
                        // Get stroke count for this kanji
                        const strokeCount = getStrokeCount(kanjiChar);
                        console.log(`Using stroke count for ${kanjiChar}: ${strokeCount}`);
                        
                        // Reset stroke counter for this element
                        drawnStrokes[elementId] = 0;
                        
                        // Check if we're on mobile
                        const isMobile = window.innerWidth <= 640;
                        const kanjiSize = isMobile ? 45 : 60;
                        const strokeWidth = isMobile ? 6 : 8;
                        
                        // DMAK options configuration
                        var dmakOptions = {
                            "uri": "data/kanji/draw/",
                            "stroke": {
                                "order": {
                                    "visible": true,
                                    "attr": {
                                        "stroke-width": strokeWidth,
                                        "stroke": "#e53e3e"
                                    }
                                }
                            },
                            "grid": {
                                "show": false
                            },
                            "autoplay": true,
                            "height": kanjiSize,
                            "width": kanjiSize,
                            "step": 0.01,
                            "drew": createDrewCallback(elementId, strokeCount)
                        };
                        
                        // If container is still problematic, recreate it
                        if ($freshContainer.length === 0 || $freshContainer.hasClass('dmak-error')) {
                            console.log(`Recreating container for element ${elementId}`);
                            $animationDisplay.html(`<div id="${drawId}" class="kanji-stroke-animation"></div>`);
                            const $newContainer = $(containerId);
                            
                            $newContainer.dmak(kanjiChar, dmakOptions);
                            $newContainer.addClass('dmak-loaded');
                            console.log(`DMAK animation recreated successfully for kanji ${kanjiChar}`);
                            return;
                        }
                        
                        $freshContainer.dmak(kanjiChar, dmakOptions);
                        
                        // Mark as loaded
                        $freshContainer.addClass('dmak-loaded');
                        console.log(`DMAK animation loaded successfully for kanji ${kanjiChar}`);
                        
                    } catch (error) {
                        console.error(`Kh√¥ng th·ªÉ t·∫£i animation cho kanji ${kanjiChar}:`, error);
                        // If animation fails, go back to static display
                        $staticDisplay.removeClass('hidden');
                        $animationDisplay.addClass('hidden');
                        animationStates[elementId] = false;
                    }
                }, 50); // 50ms delay
            }
        }
        
        // Hide stroke order animation and show static display
        function hideStrokeOrder(elementId) {
            // Check if this is a full ID or just the identifier
            const staticId = elementId.includes('static') ? elementId : `kanji-static-${elementId}`;
            const animId = elementId.includes('animation') ? elementId : `kanji-animation-${elementId}`;
            
            // Add # for jQuery selectors
            const staticDisplayId = `#${staticId}`;
            const animationDisplayId = `#${animId}`;
            
            const $staticDisplay = $(staticDisplayId);
            const $animationDisplay = $(animationDisplayId);
            
            // If we can't find the elements with these selectors, try alternative formats
            if ($staticDisplay.length === 0 || $animationDisplay.length === 0) {
                console.log(`Could not find elements for ${elementId}, trying alternative selectors`);
                // Try to find by partial match
                const partialId = elementId.replace('desktop-', '').replace('mobile-', '');
                const $allStatic = $(`[id*='${partialId}']`).filter('.kanji-static-display');
                const $allAnim = $(`[id*='${partialId}']`).filter('.kanji-animation-display');
                
                console.log(`Found ${$allStatic.length} static and ${$allAnim.length} animation elements`);
                
                if ($allStatic.length > 0) $allStatic.removeClass('hidden');
                if ($allAnim.length > 0) $allAnim.addClass('hidden');
                
                // Update state
                animationStates[elementId] = false;
                
                // Reset stroke counter
                drawnStrokes[elementId] = 0;
                return;
            }
            
            // Clear any existing timeout for this element
            if (animationTimeouts[elementId]) {
                clearTimeout(animationTimeouts[elementId]);
                delete animationTimeouts[elementId];
            }
            
            // Show static display and hide animation display
            $staticDisplay.removeClass('hidden');
            $animationDisplay.addClass('hidden');
            
            // Update state
            animationStates[elementId] = false;
            
            // Reset stroke counter
            drawnStrokes[elementId] = 0;
        }
        
        // Make functions available globally
        window.showStrokeOrder = showStrokeOrder;
        window.hideStrokeOrder = hideStrokeOrder;

        // Render kanji grid
        function renderKanjiGrid() {
            if (filteredKanji.length === 0) {
                kanjiContainer.classList.add('hidden');
                noResultsState.classList.remove('hidden');
                return;
            }

            kanjiContainer.classList.remove('hidden');
            noResultsState.classList.add('hidden');

            kanjiGrid.innerHTML = filteredKanji
                .map(kanji => createKanjiCard(kanji))
                .join('');
                
            // No auto-initialization of stroke animations
            // Animations will be loaded on-demand when user clicks the button
        }


        // Clear all filters
        function clearAllFilters() {
            searchInput.value = '';
            categoryFilter.value = '';
            applyFilters();
        }


        // Hide loading state
        function hideLoading() {
            loadingState.classList.add('hidden');
        }

        // Show error state
        function showError(message) {
            loadingState.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">üòû</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">ƒê√£ x·∫£y ra l·ªói</h2>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button onclick="location.reload()" class="action-button">
                        üîÑ Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }


        // Wait for DMAK library to load, then configure and initialize
        $(document).ready(function() {
            // Configure DMAK global settings
            if (typeof Dmak !== 'undefined' && Dmak.prototype) {
                Dmak.prototype.options = Dmak.prototype.options || {};
                Dmak.prototype.options.uri = "data/kanji/draw/";
            }
            
            initializeApp();
        });
    </script>
</body>
</html>

